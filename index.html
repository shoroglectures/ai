<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Øª Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ n8n</title>
    <style>
        /* Add the same CSS styles from above */
        /* You can enhance with typing indicators, etc. */
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>Ø´Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
            <div id="connectionStatus">ğŸŸ¢ Ù…ØªØµÙ„</div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." />
            <button id="sendButton">Ø¥Ø±Ø³Ø§Ù„</button>
            <button id="clearButton">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.n8nWebhookURL = 'http://n8n.shorog.com/webhook-test/shorogai';
                this.chatHistory = [];
                this.init();
            }

            init() {
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.clearButton = document.getElementById('clearButton');
                this.connectionStatus = document.getElementById('connectionStatus');

                this.setupEventListeners();
                this.loadChatHistory();
            }

            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.clearButton.addEventListener('click', () => this.clearChat());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;

                this.addMessage(message, 'user');
                this.messageInput.value = '';
                
                const loadingId = this.showLoading();
                
                try {
                    const response = await this.sendToN8n(message);
                    this.hideLoading(loadingId);
                    
                    const reply = response.reply || 
                                 response.response || 
                                 response.message || 
                                 'Ø´ÙƒØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„ØªÙƒ!';
                    
                    this.addMessage(reply, 'bot');
                    this.saveChatHistory();
                    
                } catch (error) {
                    this.hideLoading(loadingId);
                    this.addMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'bot');
                }
            }

            async sendToN8n(message) {
                const payload = {
                    message: message,
                    user: 'web_chat_user',
                    timestamp: new Date().toISOString(),
                    type: 'chat_message',
                    chatHistory: this.chatHistory.slice(-5) // Last 5 messages for context
                };

                const response = await fetch(this.n8nWebhookURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            }

            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                messageDiv.innerHTML = `
                    <div class="message-text">${text}</div>
                    <div class="message-time">${timestamp}</div>
                `;
                
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                
                // Save to history
                this.chatHistory.push({
                    sender: sender,
                    text: text,
                    timestamp: new Date().toISOString()
                });
            }

            showLoading() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message bot-message loading';
                loadingDiv.id = 'loading-' + Date.now();
                loadingDiv.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
                this.chatMessages.appendChild(loadingDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                return loadingDiv.id;
            }

            hideLoading(loadingId) {
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
            }

            clearChat() {
                this.chatMessages.innerHTML = '';
                this.chatHistory = [];
                localStorage.removeItem('chatHistory');
                this.addMessage('Ù…Ø±Ø­Ø¨Ø§Ù‹! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ', 'bot');
            }

            saveChatHistory() {
                localStorage.setItem('chatHistory', JSON.stringify(this.chatHistory));
            }

            loadChatHistory() {
                const saved = localStorage.getItem('chatHistory');
                if (saved) {
                    this.chatHistory = JSON.parse(saved);
                    // Re-render chat history
                    this.chatMessages.innerHTML = '';
                    this.chatHistory.forEach(msg => {
                        this.addMessage(msg.text, msg.sender);
                    });
                }
            }
        }

        // Initialize the chat app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ChatApp();
        });
    </script>
</body>
</html>
